name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies & Test
        run: |
          npm install
          npm test # Fondamentale: Scrittura test e mock [cite: 74, 101, 295]

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          [cite_start]SONAR_HOST_URL: 157.90.236.220 # O l'IP del tuo server se self-hosted [cite: 123]

      - name: Build and Push Docker
        run: |
          docker build -t timbrio-app:${{ github.sha }} .
          # Qui andrebbe il push verso un registro (Docker Hub o GitHub Packages) [cite: 158, 256]

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: 157.90.236.220
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /var/www/company
            # Comando per aggiornare il container su Kubernetes [cite: 159, 262]
            kubectl set image deployment/timbrio-app timbrio=timbrio-app:${{ github.sha }}
