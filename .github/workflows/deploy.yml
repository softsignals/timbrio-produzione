name: CI/CD Produzione

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend # Applica i comandi npm e docker nella cartella backend
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Obbligatorio per un'analisi SonarQube accurata

      - name: Install & Test
        run: |
          npm install
          npm test

      # 1. Analisi Qualità - Specifichiamo la cartella del backend per trovare tsconfig.json
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://157.90.236.220:9000
        with:
          args: >
            -Dsonar.projectKey=timbrio-backend
            -Dsonar.sources=src
            -Dsonar.typescript.tsconfigPath=tsconfig.json
            -Dsonar.projectBaseDir=backend

      # 2. Login Registry (GHCR)
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 3. Build & Push con tag univoco (SHA) e tag latest
      - name: Build and Push Docker Image
        run: |
          docker build -t ghcr.io/${{ github.repository }}/backend:${{ github.sha }} -t ghcr.io/${{ github.repository }}/backend:latest .
          docker push ghcr.io/${{ github.repository }}/backend:${{ github.sha }}
          docker push ghcr.io/${{ github.repository }}/backend:latest

      # 4. Deploy sulla VPS - Usiamo lo SHA per garantire la tracciabilità (Rollback facile)
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: 157.90.236.220
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Esegue il login al registry anche sulla VPS
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Scarica e aggiorna il container
            docker pull ghcr.io/${{ github.repository }}/backend:${{ github.sha }}
            docker stop timbrio-backend || true
            docker rm timbrio-backend || true
            
            docker run -d \
              --name timbrio-backend \
              --restart unless-stopped \
              -p 3000:3000 \
              ghcr.io/${{ github.repository }}/backend:${{ github.sha }}
